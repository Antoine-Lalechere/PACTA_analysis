## Environment

Packages used in this file:

```{r}
library(tidyverse)
library(devtools)
library(testthat)
library(config)
library(rlang)
library(renv)
library(glue)
library(fs)
library(here)
library(conflicted)
conflicted::conflict_prefer("filter", "dplyr")
conflicted::conflict_prefer("lag", "dplyr")
```

All packages detected in the directory PACTA\_analysis:

```{r}
detect_packages <- function() {
  packages <- renv::dependencies()$Package
  sort(unique(packages))
}

detect_packages()
```

<details>

<summary>Session information</summary>

```{r}
devtools::session_info()
```

</details>

## Functions

```{r}
devtools::load_all()
```

## Data

Ensure the example data is available.

```{r}
file_name <- "TestPortfolio_Input.csv"
example_dataset <- here("sample_files", "20_input_files", file_name)

expect_true(file_exists(example_dataset))
```

Ensure the example data is copied into the expected directory.

```{r}
expected_dataset <- here("working_dir", "20_Raw_Inputs", file_name)

if (file_exists(expected_dataset)) {
  warn(glue("Removing existing file: {expected_dataset}"))
  file_delete(expected_dataset)
}

file_copy(example_dataset, expected_dataset)

expect_true(file_exists(expected_dataset))
```

## Directories

Ensure the required directories exist, and are empty.

```{r}
ensure_empty_directory <- function(directory) {
  if (dir_exists(directory)) {
    not_hidden <- fs::dir_ls(directory)
    file_delete(not_hidden)
  }

  dir_create(directory)
  file_create(path(directory, ".gitkeep.txt"))

  invisible(directory)
}

children <- c("30_Processed_Inputs", "40_Results", "50_Outputs")
(paths <- here("working_dir", children))

walk(paths, ensure_empty_directory)
```

Ensure the following repos are siblings, i.e. they are inside the same parent directory:

* "2DegreesInvesting/pacta-data/"
* "2DegreesInvesting/create\_interactive_report/"
* "2DegreesInvesting/PACTA\_analysis/"
* "2DegreesInvesting/StressTestingModelDev/"

```{r}
repos <- c(
  this_repo(), 
  "pacta-data", 
  "create_interactive_report", 
  "StressTestingModelDev"
)
is_sibling <- function(x) {
  parent <- path_dir(here())
  dir_exists(path(parent, x))
}
all_siblings <- all(map_lgl(repos, is_sibling))

expect_true(all_siblings)
```

**NOTE: As of this writing the main line of development is not the standard branch `master` -- it is the branch `current_web_functionality`.**

Ensure the expected working directory.

```{r}
expect_equal(path_file(here()), this_repo())
```

## `portfolio_name_ref_all <- "TestPortfolio_Input"`

Ensure `portfolio_name_ref_all` takes the value "TestPortfolio_Input" in the files which name contains "web\_tool\_scripts".

```{r}
# What value is currently assigned to the variable `portfolio_name_ref_all`?
show_pattern_in_file <- function(file, pattern) {
  grep(pattern, readLines(file), value = TRUE)
}

pattern <- "set_portfolio-name-ref-all_working-location_and_web-parameters.R"
(files <- dir_ls("deduplicate", regexp = pattern))

this_pattern <- "portfolio_name_ref_all.*<-"
matched <- map(files, show_pattern_in_file, pattern = this_pattern)
walk(matched, writeLines)

script_has_this_pattern <- grepl(this_pattern, matched)
expect_true(any(script_has_this_pattern))
```

**NOTE: If the value of `portfolio_name_ref_all` comes from the user, we should provide an interface for the user to supply it -- so that the user needs not to change the source code.**

## Configurations

Ensure this configuration file exists:

```{r}
config_1 <- here(
  "working_dir",
  "10_Parameter_File",
  "TestPortfolio_Input_PortfolioParameters.yml"
)

expect_true(file_exists(config_1))
```

```{r}
look_into <- function(path, n = -1L) {
  lines <- readLines(path, n, encoding = "UTF-8")
  writeLines(lines)
}

look_into(config_1)
```

Ensure this other configuration file also exists:

```{r}
normal_params <- here("parameter_files", "WebParameters_2dii.yml")
docker_params <- here("parameter_files", "WebParameters_docker.yml")
config_2 <- ifelse(in_transitionmonitor(), docker_params, normal_params)

config_2_copy <- tempfile()
fs::file_copy(config_2, config_2_copy)

expect_true(file_exists(config_2))
```

Ensure the paths in the configuration file work both locally and on GitHub actions:

```{r}
make_config_portable <- function(config) {
  lines <- readLines(config, encoding = "UTF-8")
  lines <- make_paths_portable(lines)
  writeLines(lines, config)

  invisible(config)
}

make_paths_portable <- function(x) {
  x %>%
    root_field_path("project_location_ext", pattern = this_repo()) %>%
    root_field_path("data_location_ext", pattern = "pacta-data") %>%
    root_field_path("template_location", pattern = "create_interactive_report") %>%
    root_field_path("stress_test_location", pattern = "StressTestingModelDev")
}

root_field_path <- function(x, field, pattern) {
  parent <- path_dir(here())
  value <- path(parent, extract_from(x, pattern))
  sub(glue("({field}:[ ]?).*"), glue("\\1{value}/"), x)
}

extract_from <- function(x, pattern) {
  line <- grep(pattern, x, value = TRUE)
  sub(glue(".*({pattern}.*)"), "\\1", line)
}

make_config_portable(config_2)
```

```{r}
config_paths <- config::get(file = config_2)$paths
all_paths_exist <- all(map_lgl(config_paths, dir_exists))

expect_true(all_paths_exist)
```

```{r}
look_into(config_2)
```
