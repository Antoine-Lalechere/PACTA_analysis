---
title: "Integration test: Run the web tool"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  comment = "#>",
  collapse = TRUE,
  cache = FALSE
)
```

## Introduction

This document provides a reproducible example of how to run the so called "web tool". It is based on [these instructions](https://bit.ly/2RCRJn7). It is useful in three ways:

* To document this repository.
* To onboard contributors.
* As an integration test -- to test running this file produces the expected output. We do this both locally and on a continuous integration service (GitHub actions) with multiple platforms and versions of R.

```{r child="preconditions.Rmd"}

```

## Scripts

Populate the directory for processed inputs:

```{r message=FALSE}
dir_has_files <- function(path) {
  stopifnot(is_dir(path))

  contents <- dir_ls(path, recurse = TRUE)
  has_files <- any(map_lgl(contents, is_file))
  has_files
}

out_1 <- path("working_dir", "30_Processed_Inputs")

expect_false(dir_has_files(out_1))
source("web_tool_script_1.R")
expect_true(dir_has_files(out_1))
```

Populate the directory for results:

```{r message=FALSE}
out_2 <- path("working_dir", "40_Results")

expect_false(dir_has_files(out_2))
source("web_tool_script_2.R")
expect_true(dir_has_files(out_2))
```

Populate the directory for outputs:

```{r message=FALSE}
out_3 <- path("working_dir", "50_Outputs")

expect_false(dir_has_files(out_3))
source("web_tool_script_3.R")
expect_true(dir_has_files(out_3))
```

Ensure the output includes specific types of files:

```{r}
outputs <- path("working_dir", "50_Outputs")

css <- dir_ls(outputs, recurse = TRUE, regexp = "[.]css")
expect_true(length(css) > 0L)

js <- dir_ls(outputs, recurse = TRUE, regexp = "[.]js")
expect_true(length(js) > 0L)

index <- dir_ls(outputs, recurse = TRUE, regexp = "index[.]html")
expect_true(length(index) > 0L)

zip <- dir_ls(outputs, recurse = TRUE, regexp = "[.]zip")
expect_true(length(zip) > 0L)
```

## Output

```{r}
look_into(index, n = 20L)

dir_tree(path(outputs, "TestPortfolio_Input"), recurse = FALSE)
```

## TODO

* Some warnings may be avoided if required directories are created only if they don't already exist.

```r
Warning message:
In read_file(paste0(file_location, "/fund_data.fst")) :
  ~/git/pacta-data/2019Q4/cleaned_files/fund_data.fst does not exist
```

* I'm not sure if this dataset is crucial, but it's missing from my clone of pacta-data/:

```{r}
dir_ls(path("..", "pacta-data", "2019Q4", "cleaned_files"))
```

## Cleanup

Restore configuration file.

```{r}
fs::file_copy(config_2_copy, config_2, overwrite = TRUE)
```

